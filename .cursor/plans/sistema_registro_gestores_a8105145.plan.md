---
name: Sistema Registro Gestores
overview: Sistema de auto-registro web para rol_id=2 con plan único (7 días trial + tarjeta obligatoria), integración Stripe, sincronización auth.users↔usuarios, y app desktop con dashboard de gestión.
todos:
  - id: db-auth-user-id
    content: Agregar columna auth_user_id a tabla usuarios + índice
    status: completed
  - id: db-trigger-sync
    content: Crear trigger para sincronizar auth.users → public.usuarios (rol_id=2)
    status: completed
  - id: db-schema
    content: Crear tablas suscripciones, historial_pagos, registros_pendientes
    status: completed
  - id: stripe-setup
    content: Configurar producto "Plan Gestor" en Stripe con trial de 7 días
    status: completed
  - id: edge-checkout
    content: Crear Edge Function stripe-checkout (sin exponer claves en frontend)
    status: completed
  - id: edge-webhook
    content: Crear Edge Function stripe-webhook para eventos de Stripe
    status: completed
  - id: edge-portal
    content: Crear Edge Function stripe-portal para Customer Portal
    status: completed
  - id: edge-cleanup
    content: Crear Edge Function/Cron para limpiar registros incompletos (24h)
    status: completed
  - id: modify-register-page
    content: "Modificar RegisterPage.jsx existente: agregar paso de Stripe checkout"
    status: completed
  - id: landing-descarga
    content: Crear página de descarga post-registro exitoso
    status: completed
  - id: hook-subscription
    content: Crear hook useSubscription() para estado de suscripción
    status: completed
  - id: auth-context
    content: Modificar AuthContext para cargar suscripción según auth_user_id
    status: completed
  - id: gestor-dashboard
    content: Crear GestorDashboard en app desktop
    status: completed
  - id: subscription-panel
    content: Crear panel de suscripción en app (ver estado + botón portal)
    status: completed
  - id: routes-protection
    content: "Proteger rutas en app: verificar suscripción activa"
    status: pending
---

# Sistema de Registro para Gestores (rol_id = 2)

## Resumen del Modelo

- **Registro:** Exclusivamente vía WEB (reutilizar `RegisterPage.jsx` existente)
- **Producto:** App Desktop (Windows/Mac)
- **Plan único:** 7 días gratis + tarjeta obligatoria
- **Registros incompletos:** Se eliminan automáticamente en 24h
- **Gestión suscripción:** Panel en app + Stripe Portal para cambios

## IMPORTANTE: Seguridad de Claves

```
┌─────────────────────────────────────────────────────────────────────┐
│                    ARQUITECTURA DE SEGURIDAD                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  FRONTEND (Web/App)           │  BACKEND (Edge Functions)          │
│  ─────────────────            │  ────────────────────────          │
│                               │                                     │
│  ✅ VITE_STRIPE_PUBLISHABLE   │  ✅ STRIPE_SECRET_KEY              │
│     (pk_live_xxx)             │  ✅ STRIPE_WEBHOOK_SECRET          │
│     Es PÚBLICA por diseño     │  ✅ STRIPE_PRICE_ID                │
│     Solo inicia checkouts     │  ✅ SUPABASE_SERVICE_ROLE_KEY      │
│                               │                                     │
│  ❌ NUNCA exponer:            │  Estas claves SOLO viven en        │
│     - sk_live_xxx             │  Supabase Edge Functions           │
│     - whsec_xxx               │  (variables de entorno seguras)    │
│     - service_role_key        │                                     │
│                               │                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**Flujo seguro:**

1. Frontend llama a Edge Function con `auth_user_id`
2. Edge Function usa `STRIPE_SECRET_KEY` para crear checkout
3. Frontend recibe solo la URL de checkout (no claves)
4. Usuario completa pago en dominio de Stripe
5. Webhook de Stripe llama a Edge Function con firma verificada

## IMPORTANTE: Sincronización auth.users ↔ public.usuarios

Tu sistema tiene dos tablas de usuarios:

- **`auth.users`** (Supabase Auth): Maneja autenticación (email, OAuth, tokens)
- **`public.usuarios`** (tu tabla): Datos extendidos + usuarios legacy

**Estrategia: Trigger automático + columna `auth_user_id`**

```mermaid
flowchart LR
    subgraph supabase [Supabase]
        AU[auth.users] -->|Trigger| PU[public.usuarios]
    end
    
    AU -->|"id (UUID)"| Link[auth_user_id]
    Link --> PU
    
    PU -->|"Datos extendidos"| Data[rol_id, empresa_id, grupo_id, nombre, etc.]
```

## Arquitectura General

```mermaid
flowchart TB
    subgraph web [WEB - Registro]
        W1[Usuario visita web/registro] --> W2{Método auth}
        W2 --> G[Google OAuth]
        W2 --> A[Apple OAuth]
        W2 --> E[Email + Password]
        G --> W3[Crear cuenta Supabase Auth]
        A --> W3
        E --> W3
        W3 --> W4[Crear registro_pendiente en BD]
        W4 --> W5[Stripe Checkout - Trial 7 días]
        W5 -->|Abandona| X[Cuenta eliminada en 24h]
        W5 -->|Completa| W6[Crear usuario rol_id=2 + suscripción]
        W6 --> W7[Página de Descarga]
    end

    subgraph desktop [APP DESKTOP]
        D1[Usuario abre app] --> D2[Login con credenciales]
        D2 --> D3{Suscripción válida?}
        D3 -->|No existe/expirada| D4[Mensaje: Completa registro en web]
        D3 -->|Trial activo| D5[Dashboard Gestor - Trial]
        D3 -->|Pagando| D6[Dashboard Gestor - Completo]
        D5 --> D7[Panel Suscripción]
        D6 --> D7
        D7 -->|Gestionar| D8[Abre Stripe Portal en navegador]
    end

    subgraph stripe [STRIPE]
        S1[Checkout Session] -->|trial_period_days: 7| S2[Customer creado]
        S2 --> S3[Subscription con trial]
        S3 -->|Día 7| S4{Tarjeta válida?}
        S4 -->|Sí| S5[Cobra automático]
        S4 -->|No| S6[Subscription cancelled]
        S6 --> S7[Webhook actualiza BD]
        S5 --> S7
    end
```

## 1. Base de Datos

### 1.1 Modificar tabla `usuarios` existente

```sql
-- Agregar columna para vincular con auth.users
ALTER TABLE usuarios 
ADD COLUMN IF NOT EXISTS auth_user_id UUID UNIQUE;

-- Índice para búsquedas rápidas
CREATE INDEX IF NOT EXISTS idx_usuarios_auth_user_id 
ON usuarios(auth_user_id) WHERE auth_user_id IS NOT NULL;

-- Comentario
COMMENT ON COLUMN usuarios.auth_user_id IS 'UUID del usuario en auth.users (Supabase Auth). NULL para usuarios legacy.';
```

### 1.2 Trigger: Crear usuario en public.usuarios al registrarse

```sql
-- Función que se ejecuta cuando se crea usuario en auth.users
CREATE OR REPLACE FUNCTION handle_new_auth_user()
RETURNS TRIGGER AS $$
BEGIN
  -- Solo crear si viene del flujo de gestores (metadata.rol_id = 2)
  IF NEW.raw_user_meta_data->>'rol_id' = '2' THEN
    INSERT INTO public.usuarios (
      auth_user_id,
      email,
      nombre,
      rol_id,
      created_at
    ) VALUES (
      NEW.id,
      NEW.email,
      COALESCE(NEW.raw_user_meta_data->>'nombre', NEW.raw_user_meta_data->>'full_name', split_part(NEW.email, '@', 1)),
      2, -- rol_id para gestores
      NOW()
    );
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger en auth.users
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION handle_new_auth_user();
```

### 1.3 Tabla `suscripciones`

```sql
CREATE TABLE suscripciones (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  usuario_id INTEGER REFERENCES usuarios(id) ON DELETE CASCADE,
  stripe_customer_id TEXT NOT NULL,
  stripe_subscription_id TEXT,
  estado TEXT NOT NULL DEFAULT 'pending', -- pending, trialing, active, past_due, cancelled
  fecha_inicio TIMESTAMPTZ,
  fecha_fin_trial TIMESTAMPTZ,
  fecha_proxima_factura TIMESTAMPTZ,
  precio_mensual DECIMAL(10,2),
  moneda TEXT DEFAULT 'eur',
  cancelado_en TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  CONSTRAINT fk_suscripciones_usuario FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

-- Índices
CREATE INDEX idx_suscripciones_usuario ON suscripciones(usuario_id);
CREATE INDEX idx_suscripciones_estado ON suscripciones(estado);
CREATE INDEX idx_suscripciones_stripe_customer ON suscripciones(stripe_customer_id);
```

### Tabla `registros_pendientes`

```sql
-- Almacena usuarios que iniciaron registro pero no completaron pago
CREATE TABLE registros_pendientes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  auth_user_id UUID NOT NULL, -- ID de Supabase Auth
  email TEXT NOT NULL,
  nombre TEXT,
  metodo_auth TEXT, -- google, apple, email
  stripe_checkout_session_id TEXT,
  expira_en TIMESTAMPTZ DEFAULT (NOW() + INTERVAL '24 hours'),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Índice para limpieza automática
CREATE INDEX idx_registros_pendientes_expira ON registros_pendientes(expira_en);
```

### Tabla `historial_pagos`

```sql
CREATE TABLE historial_pagos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  suscripcion_id UUID REFERENCES suscripciones(id),
  stripe_payment_intent_id TEXT,
  stripe_invoice_id TEXT,
  monto DECIMAL(10,2),
  moneda TEXT,
  estado TEXT, -- succeeded, failed, refunded
  fecha_pago TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

## 2. Edge Functions (Supabase)

### `stripe-checkout`

Crea sesión de Stripe Checkout con trial obligatorio.

```typescript
// Entrada
{ auth_user_id, email, nombre, success_url, cancel_url }

// Lógica
1. Crear/obtener Stripe Customer
2. Crear Checkout Session con:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - mode: 'subscription'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - subscription_data.trial_period_days: 7
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - payment_method_collection: 'always' (tarjeta obligatoria)
3. Guardar en registros_pendientes
4. Retornar checkout_url
```

### `stripe-webhook`

Procesa eventos de Stripe.

```typescript
// Eventos a manejar:
- checkout.session.completed → Crear usuario + suscripción
- customer.subscription.updated → Actualizar estado
- customer.subscription.deleted → Marcar cancelado
- invoice.payment_succeeded → Registrar pago
- invoice.payment_failed → Marcar past_due
```

### `stripe-portal`

Genera URL del Customer Portal.

```typescript
// Entrada
{ usuario_id }

// Lógica
1. Obtener stripe_customer_id del usuario
2. Crear portal session
3. Retornar portal_url
```

### `cleanup-registros-pendientes` (Cron diario)

Limpia registros incompletos.

```typescript
// Ejecutar cada hora o diario
1. Buscar registros_pendientes WHERE expira_en < NOW()
2. Para cada uno:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - Eliminar usuario de Supabase Auth
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - Eliminar registro_pendiente
3. Log de limpieza
```

## 3. Web - Páginas de Registro

### Página de Registro (`/registro`)

**Flujo de 3 pasos:**

1. **Paso 1 - Autenticación**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Botones: Google, Apple, Email
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Si Email: formulario email + password
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Al completar: crear cuenta en Supabase Auth

2. **Paso 2 - Datos básicos**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Nombre completo
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Teléfono (opcional)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Nombre del negocio

3. **Paso 3 - Pago**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Mensaje: "7 días gratis, luego €X/mes"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Redirect a Stripe Checkout
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Si abandona: cuenta se elimina en 24h

### Página de Descarga (`/descarga`)

- Solo accesible tras checkout exitoso
- Detectar OS (Windows/Mac)
- Botón de descarga prominente
- Instrucciones de instalación
- Credenciales de acceso

### Página de Registro Incompleto (`/completar-registro`)

- Para usuarios que abandonaron checkout
- Muestra mensaje y botón para reintentar pago
- Si expira: redirige a registro nuevo

## 4. App Desktop

### Flujo de Login

```mermaid
flowchart TD
    A[App abierta] --> B[Pantalla Login]
    B --> C{Credenciales válidas?}
    C -->|No| B
    C -->|Sí| D[Verificar suscripción en BD]
    D --> E{Estado suscripción?}
    E -->|No existe| F[Modal: Completa registro en web]
    E -->|pending| F
    E -->|cancelled/past_due| G[Modal: Suscripción inactiva - Renovar]
    E -->|trialing| H[Dashboard con banner trial]
    E -->|active| I[Dashboard completo]
    F --> J[Botón: Ir a web]
    G --> K[Botón: Abrir portal de pagos]
```

### Dashboard Gestor (`GestorDashboard.jsx`)

**Componentes:**

- **Header:** Nombre usuario + días restantes trial (si aplica)
- **Panel Suscripción:** Estado, próxima factura, botón "Gestionar"
- **Sección Anuncios:** Crear/ver anuncios inmediatos
- **Sección Contenidos:** Contenidos programados
- **Sección Reproductor:** Acceso al player

### Panel de Suscripción (`SubscriptionPanel.jsx`)

```
┌─────────────────────────────────────────┐
│ Tu Suscripción                          │
├─────────────────────────────────────────┤
│ Estado: ● Activo (o Trial - 5 días)     │
│ Próxima factura: 15 Feb 2026 - €29.99   │
│                                         │
│ [Gestionar suscripción →]               │
│ (Abre Stripe Portal en navegador)       │
└─────────────────────────────────────────┘
```

## 5. Estados de Suscripción

| Estado | Descripción | Acceso App |

|--------|-------------|------------|

| `pending` | Checkout iniciado, no completado | Bloqueado |

| `trialing` | En período de prueba (7 días) | Completo |

| `active` | Pagando activamente | Completo |

| `past_due` | Pago fallido, en gracia | Limitado + aviso |

| `cancelled` | Cancelado/expirado | Bloqueado |

## 6. Configuración Stripe

### Producto a crear:

- **Nombre:** "Ondeon Gestor"
- **Precio:** €X/mes (definir)
- **Trial:** 7 días
- **Facturación:** Mensual

### Webhook events a configurar:

- `checkout.session.completed`
- `customer.subscription.created`
- `customer.subscription.updated`
- `customer.subscription.deleted`
- `invoice.payment_succeeded`
- `invoice.payment_failed`

### Variables de entorno:

```
┌──────────────────────────────────────────────────────────────────┐
│ SUPABASE EDGE FUNCTIONS (Secrets - Dashboard > Edge Functions)  │
├──────────────────────────────────────────────────────────────────┤
│ STRIPE_SECRET_KEY=sk_live_xxx      ← SECRETA, nunca en frontend │
│ STRIPE_WEBHOOK_SECRET=whsec_xxx    ← SECRETA, valida webhooks   │
│ STRIPE_PRICE_ID=price_xxx          ← ID del precio en Stripe    │
└──────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────┐
│ FRONTEND WEB (.env)                                              │
├──────────────────────────────────────────────────────────────────┤
│ VITE_STRIPE_PUBLISHABLE_KEY=pk_live_xxx                          │
│                                                                  │
│ ⚠️  Esta es la ÚNICA clave de Stripe permitida en frontend.     │
│     Empieza con "pk_" = Publishable Key = PÚBLICA por diseño.   │
│     Solo puede iniciar checkouts, NO hacer cobros.              │
└──────────────────────────────────────────────────────────────────┘
```

## 7. Archivos a Crear/Modificar

**NUEVOS:**

| Ubicación | Archivo | Descripción |

|-----------|---------|-------------|

| `database/` | `021_suscripciones_gestores.sql` | auth_user_id + trigger + tablas |

| `supabase/functions/` | `stripe-checkout/index.ts` | Crear checkout (claves seguras) |

| `supabase/functions/` | `stripe-webhook/index.ts` | Procesar eventos |

| `supabase/functions/` | `stripe-portal/index.ts` | Portal de gestión |

| `supabase/functions/` | `cleanup-pendientes/index.ts` | Limpieza cron |

| `src/pages/gestor/` | `GestorDashboard.jsx` | Dashboard principal |

| `src/components/` | `SubscriptionPanel.jsx` | Panel de suscripción |

| `src/components/` | `SubscriptionGuard.jsx` | Protección de rutas |

| `src/hooks/` | `useSubscription.js` | Hook de suscripción |

| `src/lib/` | `stripeApi.js` | API de Stripe (solo pk_) |

| `src/pages/` | `DownloadPage.jsx` | Página de descarga |

**MODIFICAR:**

| Archivo | Cambios |

|---------|---------|

| `src/pages/RegisterPage.jsx` | Agregar paso 3 (Stripe checkout) para rol_id=2 |

| `src/contexts/AuthContext.jsx` | Cargar suscripción via auth_user_id |

| `src/hooks/useRole.js` | Permisos basados en estado de suscripción |

| `src/App.jsx` | Rutas protegidas para gestores |

## 8. Consideraciones Técnicas

### OAuth en Desktop

- Google/Apple OAuth funciona en web de registro
- App desktop solo usa login tradicional (email/password)
- Usuarios OAuth pueden establecer password en web si quieren

### Sincronización auth.users ↔ public.usuarios

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   auth.users    │     │ Trigger (auto)  │     │ public.usuarios │
│  (Supabase)     │────▶│                 │────▶│   (tu tabla)    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
       │                                                 │
       │ id (UUID)                                       │ auth_user_id
       │                                                 │
       └─────────────────────────────────────────────────┘
                    Vínculo 1:1 para gestores
```

- **Usuarios legacy (rol 1, 3):** `auth_user_id = NULL` (usan login legacy)
- **Usuarios nuevos (rol 2):** `auth_user_id = UUID` (usan Supabase Auth)
- El trigger solo crea registro si `metadata.rol_id = 2`

### Sincronización de estado de suscripción

- App consulta estado de suscripción al login via `auth_user_id`
- Webhook de Stripe actualiza BD en tiempo real
- App puede refrescar estado manualmente

### Seguridad (CRÍTICO)

**En Edge Functions (backend):**

```typescript
// ✅ CORRECTO: Usar secrets de Supabase
const stripe = new Stripe(Deno.env.get('STRIPE_SECRET_KEY'));

// ✅ CORRECTO: Verificar firma del webhook
const sig = req.headers.get('stripe-signature');
const event = stripe.webhooks.constructEvent(body, sig, Deno.env.get('STRIPE_WEBHOOK_SECRET'));
```

**En Frontend:**

```javascript
// ✅ CORRECTO: Solo usar publishable key para cargar Stripe.js
import { loadStripe } from '@stripe/stripe-js';
const stripe = await loadStripe(import.meta.env.VITE_STRIPE_PUBLISHABLE_KEY);

// ✅ CORRECTO: Llamar a Edge Function para obtener checkout URL
const response = await fetch('/functions/v1/stripe-checkout', {
  method: 'POST',
  body: JSON.stringify({ auth_user_id })
});
const { checkout_url } = await response.json();
window.location.href = checkout_url; // Redirigir a Stripe

// ❌ INCORRECTO: NUNCA hacer esto
// const stripe = new Stripe('sk_live_xxx'); // NUNCA
```

**Validaciones adicionales:**

- Verificar suscripción en backend al acceder a recursos protegidos
- Tokens de sesión con expiración corta
- Rate limiting en endpoints de Stripe
- Validar que `auth_user_id` del request coincida con sesión activa